<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ganpati Lucky Spin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#ff9800;
      --accent2:#4caf50;
      --err:#e53935;
      --text-light:#fff;
    }
    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family:'Arial',sans-serif;
      background:#0b0c2c;
      min-height:100dvh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      color:var(--text-light);
      position:relative;
      overflow:hidden;
    }
    canvas#bgCanvas{ position:absolute; inset:0; width:100%; height:100%; z-index:0; }
    .wrap{
      width:95%;
      max-width:800px;
      height:100dvh;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      text-align:center;
      z-index:2;
      border-radius:20px;
      background:rgba(0,0,0,0.5);
      box-shadow:0 8px 32px rgba(0,0,0,0.7);
      padding:8px 12px 12px;
    }
    h1{margin:4px 0 6px; font-size:28px;}
    p{margin:4px 0 12px; color:#ccc; font-size:14px;}
    .controls{ display:flex; flex-direction:column; gap:8px; align-items:center; margin-bottom:10px; width:100%; }
    input[type="text"]{
      width:90%; padding:10px 12px;
      border-radius:10px; border:none; background:#222;
      color:var(--text-light); font-size:14px;
    }
    button{
      width:90%; padding:10px 12px; border-radius:10px; border:none;
      color:#fff; font-weight:700; font-size:14px; cursor:pointer;
      box-shadow:0 4px 12px rgba(255,152,0,0.5); transition:0.3s;
      background: linear-gradient(270deg, #ff9800, #ff5722, #4caf50);
      background-size: 600% 600%;
      animation: buttonGlow 6s ease infinite;
    }
    button:hover{ transform:scale(1.05); }
    @keyframes buttonGlow {
      0% { background-position: 0% 50% }
      50% { background-position: 100% 50% }
      100% { background-position: 0% 50% }
    }

    .wheel-wrap{
      position:relative;
      width:min(70vw, 360px);
      aspect-ratio:1/1;
      margin:60px auto 12px;   /* üî• lowered wheel */
      z-index:3;
    }
    canvas#wheel{
      width:100%; height:100%; border-radius:50%;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5) inset, 0 6px 16px rgba(0,0,0,0.5);
      transform: rotateX(12deg);
      display:block;
    }
    .pointer{
      position:absolute; left:50%; top:14px; transform:translateX(-50%);
      width:0; height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-top:28px solid var(--accent);
      filter:drop-shadow(0 3px 8px rgba(0,0,0,0.3));
      z-index:10;
    }

    /* üî• Premium Neon Ring */
    .wheel-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 330px;
      height: 330px;
      border-radius: 50%;
      border: 4px solid transparent;
      background: radial-gradient(circle, rgba(255,165,0,0.6) 20%, rgba(255,140,0,0.2) 70%, transparent 100%);
      box-shadow: 
            0 0 15px #ffb84d,
            0 0 30px #ff9800,
            0 0 60px #ff6f00 inset,
            0 0 80px rgba(255,152,0,0.7);
      transform: translate(-50%, -50%);
      pointer-events: none;
      animation: pulseGlow 2s infinite alternate;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 15px #ffb84d, 0 0 30px #ff9800, 0 0 50px #ff6f00 inset; }
      100% { box-shadow: 0 0 25px #ffe082, 0 0 50px #ffc107, 0 0 90px #ff6f00 inset; }
    }

    .center-logo{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90px; border-radius:50%; z-index:10; pointer-events:none; filter:drop-shadow(0 0 15px var(--accent)); }
    .top-logo{ height:90px; width:auto; display:block; margin:0 auto 6px; object-fit:contain; }
    .popup{
      margin-top:8px; padding:10px; border-radius:10px; font-weight:700;
      display:none; max-width:90%;
      font-size:16px; text-align:center; border:2px solid var(--accent);
      box-shadow:0 0 15px var(--accent); background:rgba(0,0,0,0.7);
      color:#fff;
    }
    .popup.ok{ color: var(--accent); }
    .popup.err{ color: var(--err); animation: shake 0.3s; }
    .popup.win { border-color: #4caf50; box-shadow: 0 0 20px #4caf50, 0 0 30px #4caf50; color: #4caf50; }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
    }
</style>

</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="wrap">
    <img src="static/bal_ganapati.png" alt="Bal Ganapati" class="top-logo">
    <h1 style="text-shadow:0 0 12px #ff9800;">üéâ Ganpati Lucky Spin üéâ</h1>
    <p>Codes valid until Sep 30, 2025. One-time use only.</p>

    <div class="controls">
      <input id="name" type="text" placeholder="Your name">
      <input id="code" type="text" placeholder="Enter code">
      <button id="redeemBtn">Validate & Spin</button>
    </div>

    <div class="wheel-wrap">
      <div class="wheel-ring"></div>
      <div class="pointer"></div>
      <canvas id="wheel" width="350" height="350"></canvas>
      <img src="static/logo.png" class="center-logo" alt="Center logo">
    </div>

    <div id="popup" class="popup"></div>
  </div>

  <!-- üé∂ Sound Effects -->

  <audio id="RedeemCodeSound" src="/static/sounds/redeem_code.mp3"></audio>
  <audio id="wrongCodeSound" src="/static/sounds/wrong_code.mp3"></audio>
  <audio id="usedCodeSound" src="/static/sounds/used_code.mp3"></audio>
  <audio id="expiredCodeSound" src="/static/sounds/expired_code.mp3"></audio>


  <!-- üéâ Confetti Library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <script>
    /* Cosmic Background */
    const bgCanvas=document.getElementById('bgCanvas');const bgCtx=bgCanvas.getContext('2d');let stars=[];
    function sizeBG(){bgCanvas.width=window.innerWidth;bgCanvas.height=window.innerHeight;stars=[];for(let i=0;i<200;i++){stars.push({x:Math.random()*bgCanvas.width,y:Math.random()*bgCanvas.height,r:Math.random()*1.2+0.4,alpha:Math.random(),dAlpha:Math.random()*0.02});}}function drawCosmic(){bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);const grad=bgCtx.createLinearGradient(0,0,bgCanvas.width,bgCanvas.height);grad.addColorStop(0,'#0b0c2c');grad.addColorStop(1,'#0d0d1f');bgCtx.fillStyle=grad;bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);for(let s of stars){s.alpha+=s.dAlpha;if(s.alpha<0||s.alpha>1)s.dAlpha*=-1;bgCtx.globalAlpha=s.alpha;bgCtx.fillStyle="#fff";bgCtx.beginPath();bgCtx.arc(s.x,s.y,s.r,0,Math.PI*2);bgCtx.fill();}bgCtx.globalAlpha=1;requestAnimationFrame(drawCosmic);}sizeBG();drawCosmic();window.addEventListener('resize',sizeBG);

    /* Wheel */
    const canvas=document.getElementById('wheel');const ctx=canvas.getContext('2d');const W=350,H=350,CX=W/2,CY=H/2,R=W/2-10;const textRadius=R*0.75;
    const prizes=["Smart Watch","Bluetooth Speaker","Earphones","AirPods","Analog Watch","Digital Watch"];
    const colors=["#f44336","#ff9800","#4caf50","#2196f3","#9c27b0","#e91e63"];
    const segments=prizes.length;const anglePer=(2*Math.PI)/segments;let baseRotation=0,spinning=false;
    function drawWheel(rotation){ctx.clearRect(0,0,W,H);ctx.lineWidth=2;for(let i=0;i<segments;i++){const start=rotation+i*anglePer;const end=start+anglePer;ctx.beginPath();ctx.moveTo(CX,CY);ctx.arc(CX,CY,R,start,end);ctx.closePath();ctx.fillStyle=colors[i%colors.length];ctx.fill();ctx.strokeStyle='#000';ctx.stroke();const mid=start+anglePer/2;const tx=CX+Math.cos(mid)*textRadius;const ty=CY+Math.sin(mid)*textRadius;ctx.save();ctx.translate(tx,ty);ctx.rotate(mid+Math.PI/2);ctx.textAlign='center';ctx.textBaseline='middle';ctx.font='bold 12px "Josefin Sans", sans-serif';ctx.fillStyle='#fff';ctx.fillText(prizes[i],0,0);ctx.restore();}}
    drawWheel(baseRotation);

    const popup=document.getElementById('popup');
    function playSound(type){
  if(type==="win") document.getElementById("RedeemCodeSound").play();
  if(type==="wrong") document.getElementById("wrongCodeSound").play();
  if(type==="used") document.getElementById("usedCodeSound").play();
  if(type==="expired") document.getElementById("expiredCodeSound").play();
}
    function launchConfetti(){const duration=2000;const end=Date.now()+duration;(function frame(){confetti({particleCount:6,angle:60,spread:55,origin:{x:0}});confetti({particleCount:6,angle:120,spread:55,origin:{x:1}});if(Date.now()<end)requestAnimationFrame(frame);})();}

    function showPopup(msg,type='info'){popup.textContent=msg;popup.className='popup';if(type==='ok')popup.classList.add('ok');else if(type==='err'){popup.classList.add('err');}else if(type==='win'){popup.classList.add('win');playSound("win");launchConfetti();}popup.style.display='block'; setTimeout(()=>{ popup.style.display='none'; }, 3000); }

    function spinToIndex(index, callback){const fullRotations=Math.floor(Math.random()*2)+3;const sliceCenter=(index+0.5)*anglePer;const desiredRotation=-Math.PI/2-sliceCenter+fullRotations*2*Math.PI;const start=performance.now(),duration=2200;const initial=baseRotation;function animate(now){const t=Math.min((now-start)/duration,1);const eased=1-Math.pow(1-t,3);baseRotation=initial+(desiredRotation-initial)*eased;drawWheel(baseRotation);if(t<1){requestAnimationFrame(animate);}else{spinning=false;if(callback) callback();}}spinning=true;requestAnimationFrame(animate);}

    document.getElementById('redeemBtn').addEventListener('click', () => {
  if (spinning) {
    showPopup('‚è≥ Wheel spinning ‚Äî wait', 'err');
    return;
  }

  const nameInput = document.getElementById('name');
  const codeInput = document.getElementById('code');
  const name = nameInput.value.trim();
  const code = codeInput.value.trim();

  if (!name || !code) {
    showPopup('‚ö†Ô∏è Enter your name and code', 'err');
    return;
  }

  const btn = document.getElementById("redeemBtn");
  btn.disabled = true;
  nameInput.disabled = true;
  codeInput.disabled = true;

  fetch("/api/redeem", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({name, code})
  })
  .then(r => r.json())
  .then(data => {
    if (!data.ok) {
      // Play sound based on reason
      if (data.reason === "invalid") playSound("wrong");
      else if (data.reason === "used") playSound("used");
      else if (data.reason === "expired") playSound("expired");

      showPopup(data.message, "err");
      btn.disabled = false;
      nameInput.disabled = false;
      codeInput.disabled = false;
      return;
    }

    const prize = data.prize;
    const prizeIndex = prizes.indexOf(prize);
    showPopup("Spinning... Good luck!", "ok");

    spinToIndex(prizeIndex, () => {
      showPopup(`üéâ You won: ${prize}`, "win");
      btn.disabled = false;
      nameInput.disabled = false;
      codeInput.disabled = false;
    });
  })
  .catch(err => {
    showPopup("‚ö†Ô∏è Server error", "err");
    btn.disabled = false;
    nameInput.disabled = false;
    codeInput.disabled = false;
  });
});
  </script>
</body>
</html>
